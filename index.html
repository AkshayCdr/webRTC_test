<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>WebRTC ICE Candidate Demo</title>
        <style>
            * {
                padding: 0;
                margin: 0;
            }
            .main-page {
                display: flex;
                width: 100vw;
                height: 100vh;
            }

            .remote-stream-section,
            .local-stream-section {
                display: flex;
                /* background-color: red; */

                justify-content: center;
                align-items: center;
                padding: 20px;
                width: 50%;
                border-right: 4px solid black;
                flex-direction: column;
                gap: 20px;
            }

            .video-container {
                display: flex;
                /* background-color: black; */
                border: 2px solid black;
                /* justify-content: center;

                align-items: center; */
                width: 300px;
                height: 300px;

                padding: 30px;
                margin: 20px;
            }

            #setRemoteIceCandidate,
            #setRemoteAnswer,
            #setRemoteOffer,
            #createOffer {
                width: 100px;
                height: 70px;
                font-size: large;

                color: white;

                background-color: black;

                border-radius: 10px;
            }

            .input-area {
                width: 500px;
                height: 100px;
            }
            .sdp-section {
                display: flex;
                flex-direction: column;
                gap: 20px;

                /* background-color: red; */
            }

            .input-container {
                display: flex;

                align-items: center;
                gap: 10px;
            }
        </style>
    </head>
    <body>
        <main class="main-page">
            <section class="local-stream-section">
                <h1>Local Video</h1>

                <div class="video-container">
                    <video id="localStream" autoplay playsinline muted></video>
                </div>
                <div class="sdp-section">
                    <div class="input-container">
                        <button id="createOffer">Create Offer</button>
                        <textarea
                            name="localOffer"
                            id="localOffer"
                            placeholder="local offer"
                            class="input-area"
                        ></textarea>
                    </div>
                    <textarea
                        name="localIceCandidates"
                        id="localIceCandidates"
                        placeholder="local iceCandidates"
                        class="input-area"
                    ></textarea>

                    <div class="input-container">
                        <button id="setRemoteAnswer">set remote answer</button>

                        <textarea
                            name=""
                            id="remoteAnswer"
                            placeholder="remote answer"
                            class="input-area"
                        ></textarea>
                    </div>
                </div>
            </section>
            <section class="remote-stream-section">
                <h1>Remote stream</h1>
                <div class="video-container">
                    <video
                        src=""
                        id="remoteStream"
                        autoplay
                        playsinline
                        muted
                    ></video>
                </div>

                <div class="sdp-section">
                    <div class="input-container">
                        <textarea
                            name=""
                            id="remoteOffer"
                            placeholder="remote Offer"
                            class="input-area"
                        ></textarea>

                        <button id="setRemoteOffer">set remote offer</button>
                    </div>

                    <div class="input-container">
                        <textarea
                            name=""
                            id="remoteIceCandidate"
                            placeholder="remote ice candidates"
                            class="input-area"
                        ></textarea>

                        <button id="setRemoteIceCandidate">
                            set remote ice candidate
                        </button>
                    </div>
                    <textarea
                        name=""
                        id="answer"
                        placeholder="answer"
                        class="input-area"
                    ></textarea>
                </div>
            </section>
        </main>
        <script>
            const peerConfiguration = {
                iceServers: [
                    {
                        urls: [
                            "stun:stun.l.google.com:19302",
                            "stun:stun1.l.google.com:19302",
                        ],
                    },
                ],
            };
            const btnCreateOffer = document.getElementById("createOffer");
            const offerText = document.getElementById("localOffer");
            const localIceCandidate =
                document.getElementById("localIceCandidates");
            const localVedioElement = document.getElementById("localStream");

            const remoteVedioElement = document.getElementById("remoteStream");

            const remoteICeCandidate =
                document.getElementById("remoteIceCandidate");
            const remoteOffer = document.getElementById("remoteOffer");

            const btnSetRemoteAnswer =
                document.getElementById("setRemoteAnswer");

            const btnSetRemoteIceCandidate = document.getElementById(
                "setRemoteIceCandidate"
            );
            const btnSetRemoteOffer = document.getElementById("setRemoteOffer");

            const answerText = document.getElementById("answer");
            const remoteAnswer = document.getElementById("remoteAnswer");

            let peerConnection;
            let dataChannel;

            async function init() {
                try {
                    const localStream =
                        await navigator.mediaDevices.getUserMedia({
                            video: true,
                            audio: true,
                            video: { width: 300, height: 300 },
                        });
                    localVedioElement.srcObject = localStream;

                    peerConnection = new RTCPeerConnection(peerConfiguration);

                    localStream.getTracks().forEach((track) => {
                        peerConnection.addTrack(track, localStream);
                    });

                    const channel = peerConnection.createDataChannel("chat");

                    channel.onopen = (e) => {
                        channel.send("hi me");
                    };

                    channel.onmessage = (e) => {
                        console.log(e.data);
                    };

                    peerConnection.connectionState = (e) => {
                        switch (peerConnection.connectionState) {
                            case "new":
                            case "connecting":
                                alertStatus("Connecting…");
                                break;
                            case "connected":
                                alertStatus("Online");
                                break;
                            case "disconnected":
                                alertStatus("Disconnecting…");
                                break;
                            case "closed":
                                alertStatus("Offline");
                                break;
                            case "failed":
                                alertStatus("Error");
                                break;
                            default:
                                alertStatus("Unknown");
                                break;
                        }
                    };

                    peerConnection.ondatachannel = (e) => {
                        const channel = e.channel;
                        channel.onopen = (e) => {
                            channel.send("hi back");
                        };

                        channel.onmessage = (e) => {
                            console.log(e.data);
                        };
                    };

                    peerConnection.ontrack = (e) => {
                        const [data] = e.streams;
                        remoteVedioElement.srcObject = data;
                    };

                    peerConnection.onicecandidate = (e) => {
                        console.log("ICE candidate found");
                        console.log(e);
                        if (e.candidate) {
                            localIceCandidate.value +=
                                JSON.stringify(e.candidate) + "\n";
                        }
                    };

                    btnCreateOffer.addEventListener("click", createOffer);

                    btnSetRemoteOffer.addEventListener("click", () => {
                        console.log("setting remote ice candidate");

                        const offer = remoteOffer.value;

                        if (!offer) return;

                        peerConnection.setRemoteDescription(JSON.parse(offer));

                        peerConnection.createAnswer().then((answer) => {
                            console.log("answer is ");
                            console.log(answer);
                            peerConnection.setLocalDescription(answer);
                            answerText.value = JSON.stringify(answer) + "\n";
                        });
                    });

                    btnSetRemoteIceCandidate.addEventListener(
                        "click",
                        async () => {
                            const iceCandidates =
                                remoteICeCandidate.value.split("\n");

                            if (!iceCandidates.length) return;

                            console.log("ice candidate is ");
                            console.log(iceCandidates);

                            iceCandidates.forEach((candidate) => {
                                if (candidate) {
                                    peerConnection
                                        .addIceCandidate(
                                            new RTCIceCandidate(
                                                JSON.parse(candidate)
                                            )
                                        )
                                        .then((ans) =>
                                            console.log("added ice ", ans)
                                        )
                                        .catch((err) => console.error(err));
                                }
                            });
                        }
                    );
                } catch (error) {
                    console.error("Error initializing:", error);
                }

                btnSetRemoteAnswer.addEventListener("click", () => {
                    const answer = remoteAnswer.value;

                    if (!answer) return;

                    peerConnection.setRemoteDescription(JSON.parse(answer));
                    console.log("remote answer set");
                });
            }

            async function createOffer() {
                try {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    offerText.value = JSON.stringify(
                        peerConnection.localDescription
                    );
                } catch (error) {
                    console.error("Error creating offer:", error);
                }
            }

            init();

            function alertStatus(status) {
                alert(status);
            }
        </script>
    </body>
</html>
